## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å®ç°åŸºäº Dexie (IndexedDB) çš„æœ¬åœ°å­˜å‚¨å±‚ï¼Œæ”¯æŒæµç¨‹æ•°æ®ã€è¿è¡Œè®°å½•ã€æ—¥å¿—å­˜å‚¨å’Œç‰ˆæœ¬ç®¡ç†ï¼Œæä¾›å®Œæ•´çš„ CRUD æ“ä½œå’ŒæŸ¥è¯¢èƒ½åŠ›ã€‚

## ğŸ¯ åŠŸèƒ½è¦æ±‚

### æ ¸å¿ƒäº¤ä»˜ç‰©

- [ ] **Database Schema** (`shared/storage/db.ts`)
  - æ•°æ®åº“ç»“æ„å®šä¹‰
  - ç‰ˆæœ¬è¿ç§»æœºåˆ¶
  - ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

- [ ] **Repository Pattern** (`shared/storage/repositories/`)
  - `RunRepository` - è¿è¡Œè®°å½•ç®¡ç†
  - `LogRepository` - æ—¥å¿—è®°å½•ç®¡ç†  
  - `FlowRepository` - æµç¨‹æ•°æ®ç®¡ç†
  - `VersionRepository` - ç‰ˆæœ¬å†å²ç®¡ç†

- [ ] **Storage Service** (`shared/storage/storage-service.ts`)
  - ç»Ÿä¸€å­˜å‚¨è®¿é—®å±‚
  - äº‹åŠ¡ç®¡ç†
  - æ•°æ®å¯¼å…¥å¯¼å‡º

## ğŸ”— æ¥å£çº¦å®š

```typescript
// shared/storage/repositories/run-repository.ts
export interface RunRepository {
  // åŸºç¡€ CRUD
  create(run: CreateRunRequest): Promise<string>;
  findById(id: string): Promise<RunRecord | null>;
  findByFlowId(flowId: string): Promise<RunRecord[]>;
  update(id: string, updates: Partial<RunRecord>): Promise<void>;
  delete(id: string): Promise<void>;
  
  // æŸ¥è¯¢æ–¹æ³•
  findRunning(): Promise<RunRecord[]>;
  findByDateRange(start: Date, end: Date): Promise<RunRecord[]>;
  findByStatus(status: RunStatus): Promise<RunRecord[]>;
  
  // ç»Ÿè®¡æ–¹æ³•
  getStats(flowId?: string): Promise<RunStats>;
}

// æ•°æ®åº“æ¨¡å¼
export interface DBSchema extends DBSchemaBase {
  runs: {
    key: string;
    value: RunRecord;
    indexes: {
      'by-flow': string;
      'by-status': RunStatus;
      'by-date': number;
    };
  };
  logs: {
    key: string;
    value: LogRecord;
    indexes: {
      'by-run': string;
      'by-level': LogLevel;
      'by-timestamp': number;
    };
  };
}
```

## ğŸ“Š æ•°æ®æ¨¡å‹

### RunRecord
```typescript
interface RunRecord {
  id: string;              // ULID
  flowId: string;          // æµç¨‹ID
  nodeResults: Record<string, unknown>; // èŠ‚ç‚¹æ‰§è¡Œç»“æœ
  status: 'running' | 'success' | 'failed' | 'cancelled';
  startedAt: number;       // å¼€å§‹æ—¶é—´æˆ³
  finishedAt?: number;     // ç»“æŸæ—¶é—´æˆ³
  traceId: string;         // é“¾è·¯è¿½è¸ªID
  metadata: {
    triggerType: 'manual' | 'scheduled' | 'webhook';
    environment: string;
    version: string;
  };
}
```

### LogRecord
```typescript
interface LogRecord {
  id: string;              // ULID
  runId: string;           // æ‰€å±è¿è¡Œè®°å½•
  nodeId?: string;         // æ‰€å±èŠ‚ç‚¹ï¼ˆå¯é€‰ï¼‰
  timestamp: number;       // æ—¶é—´æˆ³
  level: 'debug' | 'info' | 'warn' | 'error';
  event: string;           // äº‹ä»¶åç§°
  message: string;         // æ—¥å¿—æ¶ˆæ¯
  data?: unknown;          // é™„åŠ æ•°æ®
  traceId: string;         // é“¾è·¯è¿½è¸ªID
}
```

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒè¯
- [ ] æ‰€æœ‰ CRUD æ“ä½œæ­£å¸¸å·¥ä½œ
- [ ] å¤æ‚æŸ¥è¯¢æ€§èƒ½æ»¡è¶³è¦æ±‚ï¼ˆ< 100msï¼‰
- [ ] äº‹åŠ¡å›æ»šæœºåˆ¶æ­£ç¡®
- [ ] å¹¶å‘è®¿é—®å®‰å…¨æ€§éªŒè¯

### æ•°æ®å®Œæ•´æ€§
- [ ] å¤–é”®çº¦æŸæ­£ç¡®æ‰§è¡Œ
- [ ] æ•°æ®è¿ç§»æ— ä¸¢å¤±
- [ ] ç´¢å¼•æŸ¥è¯¢å‡†ç¡®æ€§éªŒè¯
- [ ] å¤§æ•°æ®é‡æµ‹è¯•ï¼ˆ10K+ è®°å½•ï¼‰

### æ€§èƒ½è¦æ±‚
- [ ] å•æ¬¡æŸ¥è¯¢ < 50ms
- [ ] æ‰¹é‡æ’å…¥ 1000 æ¡è®°å½• < 500ms
- [ ] å…¨æ–‡æœç´¢å“åº” < 200ms
- [ ] æ•°æ®åº“æ–‡ä»¶å¤§å°åˆç†å¢é•¿

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
```typescript
describe('RunRepository', () => {
  let repo: RunRepository;
  
  beforeEach(async () => {
    repo = new RunRepository(testDb);
  });

  it('should create and retrieve run record', async () => {
    const runId = await repo.create({
      flowId: 'flow-123',
      status: 'running',
      traceId: 'trace-456'
    });
    
    const run = await repo.findById(runId);
    expect(run).toBeDefined();
    expect(run?.flowId).toBe('flow-123');
  });

  it('should handle concurrent updates', async () => {
    const runId = await repo.create({ ... });
    
    await Promise.all([
      repo.update(runId, { status: 'success' }),
      repo.update(runId, { finishedAt: Date.now() })
    ]);
    
    const run = await repo.findById(runId);
    expect(run?.status).toBe('success');
    expect(run?.finishedAt).toBeDefined();
  });
});
```

### é›†æˆæµ‹è¯•
- [ ] å¤šè¡¨è”åˆæŸ¥è¯¢
- [ ] æ•°æ®å¯¼å…¥å¯¼å‡ºå®Œæ•´æ€§
- [ ] æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•
- [ ] ç¦»çº¿åœºæ™¯æµ‹è¯•

### æ€§èƒ½æµ‹è¯•
- [ ] å¤§æ•°æ®é›†æŸ¥è¯¢åŸºå‡†
- [ ] å†…å­˜ä½¿ç”¨ç›‘æ§
- [ ] å­˜å‚¨ç©ºé—´ä¼˜åŒ–éªŒè¯

## â›“ï¸ ä¾èµ–å…³ç³»

**å‰ç½®ä¾èµ–ï¼š**
- T1.1 ç±»å‹ç³»ç»Ÿï¼ˆRunRecordã€LogRecord ç­‰ï¼‰

**åç»­ä»»åŠ¡ï¼š**
- T3.4 æµç¨‹åºåˆ—åŒ–ä¼šä½¿ç”¨å­˜å‚¨æ¥å£
- T4.2 ç›‘æ§ä»ªè¡¨æ¿ä¼šæŸ¥è¯¢è¿è¡Œæ•°æ®
- T5.3 æ—¥å¿—æŸ¥çœ‹å™¨ä¼šä½¿ç”¨æ—¥å¿—å­˜å‚¨

## ğŸ”§ æ•°æ®åº“è®¾è®¡

### è¡¨ç»“æ„ä¸ç´¢å¼•
```typescript
const db = new Dexie('SuperflowDB');
db.version(1).stores({
  runs: 'id, flowId, status, startedAt, traceId',
  logs: 'id, runId, nodeId, timestamp, level, traceId',
  flows: 'id, name, createdAt, updatedAt, version',
  versions: 'id, flowId, createdAt, author, version'
});

// å¤åˆç´¢å¼•
db.version(2).stores({
  runs: 'id, flowId, status, startedAt, traceId, [flowId+status], [startedAt+status]',
  logs: 'id, runId, nodeId, timestamp, level, traceId, [runId+level], [timestamp+level]'
});
```

### è¿ç§»ç­–ç•¥
```typescript
// ç‰ˆæœ¬ 1 â†’ 2 è¿ç§»
db.version(2).upgrade(tx => {
  return tx.table('runs').toCollection().modify(run => {
    if (!run.metadata) {
      run.metadata = {
        triggerType: 'manual',
        environment: 'development',
        version: '1.0.0'
      };
    }
  });
});
```

## ğŸ“¦ å¯¼å…¥å¯¼å‡ºæ ¼å¼

### å¯¼å‡ºæ ¼å¼
```typescript
interface ExportData {
  version: string;
  timestamp: number;
  data: {
    runs: RunRecord[];
    logs: LogRecord[];
    flows: FlowRecord[];
  };
  checksum: string;
}
```

### å¯¼å…¥éªŒè¯
- ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
- æ•°æ®å®Œæ•´æ€§éªŒè¯
- é‡å¤æ•°æ®å¤„ç†
- å¢é‡å¯¼å…¥æ”¯æŒ

## ğŸ“š å‚è€ƒèµ„æ–™

- [Dexie.js æ–‡æ¡£](https://dexie.org/)
- [IndexedDB æœ€ä½³å®è·µ](https://developers.google.com/web/fundamentals/instant-and-offline/web-storage/indexeddb-best-practices)
- [æ•°æ®åº“è®¾è®¡æ¨¡å¼](https://www.patterns.dev/posts/repository-pattern/)

## ğŸš¨ æ³¨æ„äº‹é¡¹

- IndexedDB æœ‰å­˜å‚¨é…é¢é™åˆ¶
- å¼‚æ­¥æ“ä½œéœ€è¦æ­£ç¡®çš„é”™è¯¯å¤„ç†
- å¤§å¯¹è±¡å­˜å‚¨å¯èƒ½å½±å“æ€§èƒ½
- è€ƒè™‘æ•°æ®å‹ç¼©å’Œåˆ†é¡µç­–ç•¥
- Safari éšç§æ¨¡å¼é™åˆ¶