## 📋 任务概述

实现基于 Dexie (IndexedDB) 的本地存储层，支持流程数据、运行记录、日志存储和版本管理，提供完整的 CRUD 操作和查询能力。

## 🎯 功能要求

### 核心交付物

- [ ] **Database Schema** (`shared/storage/db.ts`)
  - 数据库结构定义
  - 版本迁移机制
  - 索引优化策略

- [ ] **Repository Pattern** (`shared/storage/repositories/`)
  - `RunRepository` - 运行记录管理
  - `LogRepository` - 日志记录管理  
  - `FlowRepository` - 流程数据管理
  - `VersionRepository` - 版本历史管理

- [ ] **Storage Service** (`shared/storage/storage-service.ts`)
  - 统一存储访问层
  - 事务管理
  - 数据导入导出

## 🔗 接口约定

```typescript
// shared/storage/repositories/run-repository.ts
export interface RunRepository {
  // 基础 CRUD
  create(run: CreateRunRequest): Promise<string>;
  findById(id: string): Promise<RunRecord | null>;
  findByFlowId(flowId: string): Promise<RunRecord[]>;
  update(id: string, updates: Partial<RunRecord>): Promise<void>;
  delete(id: string): Promise<void>;
  
  // 查询方法
  findRunning(): Promise<RunRecord[]>;
  findByDateRange(start: Date, end: Date): Promise<RunRecord[]>;
  findByStatus(status: RunStatus): Promise<RunRecord[]>;
  
  // 统计方法
  getStats(flowId?: string): Promise<RunStats>;
}

// 数据库模式
export interface DBSchema extends DBSchemaBase {
  runs: {
    key: string;
    value: RunRecord;
    indexes: {
      'by-flow': string;
      'by-status': RunStatus;
      'by-date': number;
    };
  };
  logs: {
    key: string;
    value: LogRecord;
    indexes: {
      'by-run': string;
      'by-level': LogLevel;
      'by-timestamp': number;
    };
  };
}
```

## 📊 数据模型

### RunRecord
```typescript
interface RunRecord {
  id: string;              // ULID
  flowId: string;          // 流程ID
  nodeResults: Record<string, unknown>; // 节点执行结果
  status: 'running' | 'success' | 'failed' | 'cancelled';
  startedAt: number;       // 开始时间戳
  finishedAt?: number;     // 结束时间戳
  traceId: string;         // 链路追踪ID
  metadata: {
    triggerType: 'manual' | 'scheduled' | 'webhook';
    environment: string;
    version: string;
  };
}
```

### LogRecord
```typescript
interface LogRecord {
  id: string;              // ULID
  runId: string;           // 所属运行记录
  nodeId?: string;         // 所属节点（可选）
  timestamp: number;       // 时间戳
  level: 'debug' | 'info' | 'warn' | 'error';
  event: string;           // 事件名称
  message: string;         // 日志消息
  data?: unknown;          // 附加数据
  traceId: string;         // 链路追踪ID
}
```

## ✅ 验收标准

### 功能验证
- [ ] 所有 CRUD 操作正常工作
- [ ] 复杂查询性能满足要求（< 100ms）
- [ ] 事务回滚机制正确
- [ ] 并发访问安全性验证

### 数据完整性
- [ ] 外键约束正确执行
- [ ] 数据迁移无丢失
- [ ] 索引查询准确性验证
- [ ] 大数据量测试（10K+ 记录）

### 性能要求
- [ ] 单次查询 < 50ms
- [ ] 批量插入 1000 条记录 < 500ms
- [ ] 全文搜索响应 < 200ms
- [ ] 数据库文件大小合理增长

## 🧪 测试计划

### 单元测试
```typescript
describe('RunRepository', () => {
  let repo: RunRepository;
  
  beforeEach(async () => {
    repo = new RunRepository(testDb);
  });

  it('should create and retrieve run record', async () => {
    const runId = await repo.create({
      flowId: 'flow-123',
      status: 'running',
      traceId: 'trace-456'
    });
    
    const run = await repo.findById(runId);
    expect(run).toBeDefined();
    expect(run?.flowId).toBe('flow-123');
  });

  it('should handle concurrent updates', async () => {
    const runId = await repo.create({ ... });
    
    await Promise.all([
      repo.update(runId, { status: 'success' }),
      repo.update(runId, { finishedAt: Date.now() })
    ]);
    
    const run = await repo.findById(runId);
    expect(run?.status).toBe('success');
    expect(run?.finishedAt).toBeDefined();
  });
});
```

### 集成测试
- [ ] 多表联合查询
- [ ] 数据导入导出完整性
- [ ] 浏览器兼容性测试
- [ ] 离线场景测试

### 性能测试
- [ ] 大数据集查询基准
- [ ] 内存使用监控
- [ ] 存储空间优化验证

## ⛓️ 依赖关系

**前置依赖：**
- T1.1 类型系统（RunRecord、LogRecord 等）

**后续任务：**
- T3.4 流程序列化会使用存储接口
- T4.2 监控仪表板会查询运行数据
- T5.3 日志查看器会使用日志存储

## 🔧 数据库设计

### 表结构与索引
```typescript
const db = new Dexie('SuperflowDB');
db.version(1).stores({
  runs: 'id, flowId, status, startedAt, traceId',
  logs: 'id, runId, nodeId, timestamp, level, traceId',
  flows: 'id, name, createdAt, updatedAt, version',
  versions: 'id, flowId, createdAt, author, version'
});

// 复合索引
db.version(2).stores({
  runs: 'id, flowId, status, startedAt, traceId, [flowId+status], [startedAt+status]',
  logs: 'id, runId, nodeId, timestamp, level, traceId, [runId+level], [timestamp+level]'
});
```

### 迁移策略
```typescript
// 版本 1 → 2 迁移
db.version(2).upgrade(tx => {
  return tx.table('runs').toCollection().modify(run => {
    if (!run.metadata) {
      run.metadata = {
        triggerType: 'manual',
        environment: 'development',
        version: '1.0.0'
      };
    }
  });
});
```

## 📦 导入导出格式

### 导出格式
```typescript
interface ExportData {
  version: string;
  timestamp: number;
  data: {
    runs: RunRecord[];
    logs: LogRecord[];
    flows: FlowRecord[];
  };
  checksum: string;
}
```

### 导入验证
- 版本兼容性检查
- 数据完整性验证
- 重复数据处理
- 增量导入支持

## 📚 参考资料

- [Dexie.js 文档](https://dexie.org/)
- [IndexedDB 最佳实践](https://developers.google.com/web/fundamentals/instant-and-offline/web-storage/indexeddb-best-practices)
- [数据库设计模式](https://www.patterns.dev/posts/repository-pattern/)

## 🚨 注意事项

- IndexedDB 有存储配额限制
- 异步操作需要正确的错误处理
- 大对象存储可能影响性能
- 考虑数据压缩和分页策略
- Safari 隐私模式限制