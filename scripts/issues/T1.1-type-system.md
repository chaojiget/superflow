## 📋 任务概述

实现 Superflow 核心类型系统，包括运行时协议、错误模型、存储接口等基础类型定义。

## 🎯 功能要求

### 核心交付物

- [ ] **Runtime Types** (`shared/types/runtime.ts`)
  - `ExecRequest` - 执行请求接口
  - `ExecResult` - 执行结果接口
  - `NodeContext` - 节点执行上下文
  - `ExecEvent` - 执行事件流接口

- [ ] **Error Model** (`shared/types/error.ts`)
  - 统一错误接口 `SuperflowError`
  - 错误码枚举 `ErrorCode`
  - 错误工厂函数

- [ ] **Storage Interfaces** (`shared/types/storage.ts`)
  - `RunRecord` - 运行记录
  - `LogRecord` - 日志记录
  - `VersionRecord` - 版本记录

## 🔗 接口约定

```typescript
// shared/types/runtime.ts
export interface ExecRequest {
  nodeId: string; // 节点唯一标识
  code: string; // 用户代码
  input: unknown; // 输入数据
  timeout?: number; // 超时时间(ms)
  traceId: string; // 链路追踪ID
}

export interface ExecResult {
  output: unknown; // 输出结果
  logs: LogEntry[]; // 执行日志
  duration: number; // 执行耗时(ms)
  error?: SuperflowError; // 错误信息
}

export interface NodeContext {
  signal: AbortSignal; // 取消信号
  logger: Logger; // 日志记录器
  env?: Record<string, string>; // 环境变量
  kv?: KVStore; // KV存储接口
}
```

## ✅ 验收标准

### 功能验证

- [ ] 所有类型导出正确，无 TypeScript 错误
- [ ] 类型可以正确序列化/反序列化为 JSON
- [ ] 错误模型支持嵌套 cause 链
- [ ] 所有接口都有完整的 JSDoc 注释

### 测试要求

- [ ] 类型兼容性测试 (`__tests__/types.test.ts`)
- [ ] JSON 序列化测试
- [ ] 错误处理测试
- [ ] 测试覆盖率 ≥ 90%

### 文档要求

- [ ] API 文档更新
- [ ] 类型使用示例
- [ ] 迁移指南（如有破坏性变更）

## ⛓️ 依赖关系

**前置依赖：** 无

**后续任务：**

- T1.2 Web Worker 运行时会使用这些类型
- T1.3 存储层会实现存储接口
- T3.2 节点系统会使用执行接口

## 🧪 测试计划

### 单元测试

```typescript
// 测试类型兼容性
describe('ExecRequest', () => {
  it('should serialize to JSON correctly', () => {
    const request: ExecRequest = { ... };
    expect(JSON.parse(JSON.stringify(request))).toEqual(request);
  });
});

// 测试错误模型
describe('SuperflowError', () => {
  it('should support error cause chain', () => {
    const rootCause = new Error('Network timeout');
    const error = createError('EXECUTION_FAILED', 'Node execution failed', rootCause);
    expect(error.cause).toBe(rootCause);
  });
});
```

### 集成测试

- 与 Web Worker 通信的类型兼容性
- 与 Dexie 存储的类型映射

## 📚 参考资料

- [TypeScript 严格模式配置](https://www.typescriptlang.org/tsconfig#strict)
- [Structured Clone 算法限制](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm)
- [错误处理最佳实践](https://nodejs.org/api/errors.html)

## 🚨 注意事项

- 所有类型必须支持 Structured Clone（用于 Web Worker 通信）
- 避免使用 `any` 类型，必要时使用 `unknown`
- 错误信息不能包含敏感信息
- 考虑未来扩展性，但避免过度设计
