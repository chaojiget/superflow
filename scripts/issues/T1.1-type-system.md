## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å®ç° Superflow æ ¸å¿ƒç±»å‹ç³»ç»Ÿï¼ŒåŒ…æ‹¬è¿è¡Œæ—¶åè®®ã€é”™è¯¯æ¨¡å‹ã€å­˜å‚¨æ¥å£ç­‰åŸºç¡€ç±»å‹å®šä¹‰ã€‚

## ğŸ¯ åŠŸèƒ½è¦æ±‚

### æ ¸å¿ƒäº¤ä»˜ç‰©

- [ ] **Runtime Types** (`shared/types/runtime.ts`)
  - `ExecRequest` - æ‰§è¡Œè¯·æ±‚æ¥å£
  - `ExecResult` - æ‰§è¡Œç»“æœæ¥å£
  - `NodeContext` - èŠ‚ç‚¹æ‰§è¡Œä¸Šä¸‹æ–‡
  - `ExecEvent` - æ‰§è¡Œäº‹ä»¶æµæ¥å£

- [ ] **Error Model** (`shared/types/error.ts`)
  - ç»Ÿä¸€é”™è¯¯æ¥å£ `SuperflowError`
  - é”™è¯¯ç æšä¸¾ `ErrorCode`
  - é”™è¯¯å·¥å‚å‡½æ•°

- [ ] **Storage Interfaces** (`shared/types/storage.ts`)
  - `RunRecord` - è¿è¡Œè®°å½•
  - `LogRecord` - æ—¥å¿—è®°å½•
  - `VersionRecord` - ç‰ˆæœ¬è®°å½•

## ğŸ”— æ¥å£çº¦å®š

```typescript
// shared/types/runtime.ts
export interface ExecRequest {
  nodeId: string; // èŠ‚ç‚¹å”¯ä¸€æ ‡è¯†
  code: string; // ç”¨æˆ·ä»£ç 
  input: unknown; // è¾“å…¥æ•°æ®
  timeout?: number; // è¶…æ—¶æ—¶é—´(ms)
  traceId: string; // é“¾è·¯è¿½è¸ªID
}

export interface ExecResult {
  output: unknown; // è¾“å‡ºç»“æœ
  logs: LogEntry[]; // æ‰§è¡Œæ—¥å¿—
  duration: number; // æ‰§è¡Œè€—æ—¶(ms)
  error?: SuperflowError; // é”™è¯¯ä¿¡æ¯
}

export interface NodeContext {
  signal: AbortSignal; // å–æ¶ˆä¿¡å·
  logger: Logger; // æ—¥å¿—è®°å½•å™¨
  env?: Record<string, string>; // ç¯å¢ƒå˜é‡
  kv?: KVStore; // KVå­˜å‚¨æ¥å£
}
```

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒè¯

- [ ] æ‰€æœ‰ç±»å‹å¯¼å‡ºæ­£ç¡®ï¼Œæ—  TypeScript é”™è¯¯
- [ ] ç±»å‹å¯ä»¥æ­£ç¡®åºåˆ—åŒ–/ååºåˆ—åŒ–ä¸º JSON
- [ ] é”™è¯¯æ¨¡å‹æ”¯æŒåµŒå¥— cause é“¾
- [ ] æ‰€æœ‰æ¥å£éƒ½æœ‰å®Œæ•´çš„ JSDoc æ³¨é‡Š

### æµ‹è¯•è¦æ±‚

- [ ] ç±»å‹å…¼å®¹æ€§æµ‹è¯• (`__tests__/types.test.ts`)
- [ ] JSON åºåˆ—åŒ–æµ‹è¯•
- [ ] é”™è¯¯å¤„ç†æµ‹è¯•
- [ ] æµ‹è¯•è¦†ç›–ç‡ â‰¥ 90%

### æ–‡æ¡£è¦æ±‚

- [ ] API æ–‡æ¡£æ›´æ–°
- [ ] ç±»å‹ä½¿ç”¨ç¤ºä¾‹
- [ ] è¿ç§»æŒ‡å—ï¼ˆå¦‚æœ‰ç ´åæ€§å˜æ›´ï¼‰

## â›“ï¸ ä¾èµ–å…³ç³»

**å‰ç½®ä¾èµ–ï¼š** æ— 

**åç»­ä»»åŠ¡ï¼š**

- T1.2 Web Worker è¿è¡Œæ—¶ä¼šä½¿ç”¨è¿™äº›ç±»å‹
- T1.3 å­˜å‚¨å±‚ä¼šå®ç°å­˜å‚¨æ¥å£
- T3.2 èŠ‚ç‚¹ç³»ç»Ÿä¼šä½¿ç”¨æ‰§è¡Œæ¥å£

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

```typescript
// æµ‹è¯•ç±»å‹å…¼å®¹æ€§
describe('ExecRequest', () => {
  it('should serialize to JSON correctly', () => {
    const request: ExecRequest = { ... };
    expect(JSON.parse(JSON.stringify(request))).toEqual(request);
  });
});

// æµ‹è¯•é”™è¯¯æ¨¡å‹
describe('SuperflowError', () => {
  it('should support error cause chain', () => {
    const rootCause = new Error('Network timeout');
    const error = createError('EXECUTION_FAILED', 'Node execution failed', rootCause);
    expect(error.cause).toBe(rootCause);
  });
});
```

### é›†æˆæµ‹è¯•

- ä¸ Web Worker é€šä¿¡çš„ç±»å‹å…¼å®¹æ€§
- ä¸ Dexie å­˜å‚¨çš„ç±»å‹æ˜ å°„

## ğŸ“š å‚è€ƒèµ„æ–™

- [TypeScript ä¸¥æ ¼æ¨¡å¼é…ç½®](https://www.typescriptlang.org/tsconfig#strict)
- [Structured Clone ç®—æ³•é™åˆ¶](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm)
- [é”™è¯¯å¤„ç†æœ€ä½³å®è·µ](https://nodejs.org/api/errors.html)

## ğŸš¨ æ³¨æ„äº‹é¡¹

- æ‰€æœ‰ç±»å‹å¿…é¡»æ”¯æŒ Structured Cloneï¼ˆç”¨äº Web Worker é€šä¿¡ï¼‰
- é¿å…ä½¿ç”¨ `any` ç±»å‹ï¼Œå¿…è¦æ—¶ä½¿ç”¨ `unknown`
- é”™è¯¯ä¿¡æ¯ä¸èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯
- è€ƒè™‘æœªæ¥æ‰©å±•æ€§ï¼Œä½†é¿å…è¿‡åº¦è®¾è®¡
