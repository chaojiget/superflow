## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å®ç°åŸºäº Web Worker çš„æ²™ç®±ä»£ç æ‰§è¡Œç¯å¢ƒï¼Œæ”¯æŒç”¨æˆ·ä»£ç å®‰å…¨æ‰§è¡Œã€è¶…æ—¶æ§åˆ¶ã€é”™è¯¯å¤„ç†å’Œæ—¥å¿—æ”¶é›†ã€‚

## ğŸ¯ åŠŸèƒ½è¦æ±‚

### æ ¸å¿ƒäº¤ä»˜ç‰©

- [ ] **Worker Client** (`shared/runtime/worker-client.ts`)
  - Worker ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - ä»£ç æ‰§è¡Œæ¥å£
  - è¶…æ—¶å’Œå–æ¶ˆæœºåˆ¶
  - é”™è¯¯å¤„ç†å’Œé‡è¯•

- [ ] **Worker Implementation** (`shared/runtime/worker.ts`)
  - å®‰å…¨æ²™ç®±ç¯å¢ƒ
  - åŠ¨æ€ä»£ç åŠ è½½å’Œæ‰§è¡Œ
  - æ—¥å¿—æ”¶é›†å’Œäº‹ä»¶ä¸ŠæŠ¥
  - èµ„æºé™åˆ¶å’Œç›‘æ§

- [ ] **Module Loader** (`shared/runtime/module-loader.ts`)
  - åŸºäº Blob URL çš„ ESM åŠ è½½
  - ä»£ç è½¬æ¢å’Œæ³¨å…¥
  - ä¾èµ–ç®¡ç†

## ğŸ”— æ¥å£çº¦å®š

```typescript
// shared/runtime/worker-client.ts
export class WorkerClient {
  constructor(options?: WorkerOptions);
  
  async execute(request: ExecRequest): Promise<ExecResult>;
  async terminate(): Promise<void>;
  
  on(event: 'log', handler: (log: LogEntry) => void): void;
  on(event: 'error', handler: (error: SuperflowError) => void): void;
  on(event: 'progress', handler: (progress: ExecProgress) => void): void;
}

// Worker é…ç½®é€‰é¡¹
export interface WorkerOptions {
  timeout?: number;        // é»˜è®¤è¶…æ—¶æ—¶é—´
  maxMemory?: number;      // å†…å­˜é™åˆ¶
  allowedModules?: string[]; // å…è®¸çš„æ¨¡å—åˆ—è¡¨
}
```

## ğŸ›¡ï¸ å®‰å…¨è¦æ±‚

### æ²™ç®±é™åˆ¶
- [ ] ç¦æ­¢è®¿é—® DOM å’Œ BOM API
- [ ] ç¦æ­¢ç½‘ç»œè¯·æ±‚ï¼ˆé™¤éç™½åå•ï¼‰
- [ ] ç¦æ­¢æ–‡ä»¶ç³»ç»Ÿè®¿é—®
- [ ] ç¦æ­¢æ‰§è¡Œ eval() å’Œ Function()
- [ ] å†…å­˜ä½¿ç”¨é™åˆ¶

### æ‰§è¡Œé™åˆ¶
- [ ] ç¡¬è¶…æ—¶æ§åˆ¶ï¼ˆé»˜è®¤ 15sï¼‰
- [ ] CPU ä½¿ç”¨ç›‘æ§
- [ ] æ— é™å¾ªç¯æ£€æµ‹
- [ ] é€’å½’æ·±åº¦é™åˆ¶

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒè¯
- [ ] å¯æ‰§è¡Œç®€å• JavaScript ä»£ç 
- [ ] æ”¯æŒ async/await å’Œ Promise
- [ ] æ­£ç¡®å¤„ç†ç”¨æˆ·ä»£ç é”™è¯¯
- [ ] è¶…æ—¶æœºåˆ¶å·¥ä½œæ­£å¸¸
- [ ] å–æ¶ˆæ“ä½œç«‹å³ç”Ÿæ•ˆ

### æ€§èƒ½è¦æ±‚
- [ ] Worker å¯åŠ¨æ—¶é—´ < 100ms
- [ ] ä»£ç æ‰§è¡Œå¼€é”€ < 10msï¼ˆä¸å«ç”¨æˆ·ä»£ç ï¼‰
- [ ] å†…å­˜æ³„æ¼æ£€æµ‹é€šè¿‡
- [ ] æ”¯æŒå¹¶å‘æ‰§è¡Œå¤šä¸ªè¯·æ±‚

### å…¼å®¹æ€§
- [ ] Chrome 80+ æ”¯æŒ
- [ ] Firefox 78+ æ”¯æŒ  
- [ ] Safari 14+ æ”¯æŒ
- [ ] Edge 80+ æ”¯æŒ

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
```typescript
describe('WorkerClient', () => {
  it('should execute simple code', async () => {
    const client = new WorkerClient();
    const result = await client.execute({
      nodeId: 'test',
      code: 'export async function handler(input) { return input * 2; }',
      input: 5,
      traceId: 'trace-123'
    });
    expect(result.output).toBe(10);
  });

  it('should handle timeout', async () => {
    const client = new WorkerClient({ timeout: 1000 });
    await expect(client.execute({
      nodeId: 'test',
      code: 'export async function handler() { while(true) {} }',
      input: null,
      traceId: 'trace-123'
    })).rejects.toThrow('EXECUTION_TIMEOUT');
  });
});
```

### é›†æˆæµ‹è¯•
- [ ] ä¸ä¸»çº¿ç¨‹çš„æ¶ˆæ¯ä¼ é€’
- [ ] å¤šä¸ª Worker å¹¶å‘æ‰§è¡Œ
- [ ] Worker å´©æºƒæ¢å¤
- [ ] å†…å­˜å‹åŠ›æµ‹è¯•

### è¾¹ç•Œæµ‹è¯•
- [ ] å¤§æ•°æ®é‡è¾“å…¥/è¾“å‡º
- [ ] å¤æ‚å¯¹è±¡åºåˆ—åŒ–
- [ ] é”™è¯¯å †æ ˆä¿¡æ¯ä¿ç•™
- [ ] é•¿æ—¶é—´è¿è¡Œåœºæ™¯

## â›“ï¸ ä¾èµ–å…³ç³»

**å‰ç½®ä¾èµ–ï¼š**
- T1.1 ç±»å‹ç³»ç»Ÿï¼ˆExecRequestã€ExecResult ç­‰ï¼‰

**åç»­ä»»åŠ¡ï¼š**
- T3.2 èŠ‚ç‚¹ç³»ç»Ÿä¼šä½¿ç”¨æ­¤è¿è¡Œæ—¶
- T4.1 è°ƒåº¦å¼•æ“ä¼šç®¡ç† Worker æ± 
- T5.2 ç›‘æ§ç³»ç»Ÿä¼šæ”¶é›†æ‰§è¡ŒæŒ‡æ ‡

## ğŸ”§ æŠ€æœ¯å®ç°

### Worker æ¶æ„
```
ä¸»çº¿ç¨‹ â†’ WorkerClient â†’ MessageChannel â†’ Worker â†’ UserCode
   â†‘                                              â†“
æ—¥å¿—/äº‹ä»¶ â† EventEmitter â† MessageChannel â† æ‰§è¡Œç»“æœ
```

### ä»£ç æ‰§è¡Œæµç¨‹
1. æ¥æ”¶ ExecRequest
2. åˆ›å»ºæ¨¡å— Blob URL
3. åŠ¨æ€ import ç”¨æˆ·ä»£ç 
4. éªŒè¯å¯¼å‡ºæ¥å£
5. åˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡
6. è°ƒç”¨ handler å‡½æ•°
7. æ”¶é›†æ—¥å¿—å’Œç»“æœ
8. è¿”å› ExecResult

### é”™è¯¯å¤„ç†ç­–ç•¥
- è¯­æ³•é”™è¯¯ï¼šç¼–è¯‘æ—¶æ•è·
- è¿è¡Œæ—¶é”™è¯¯ï¼štry/catch åŒ…è£…
- è¶…æ—¶é”™è¯¯ï¼šAbortController å–æ¶ˆ
- ç³»ç»Ÿé”™è¯¯ï¼šWorker é‡å¯

## ğŸ“š å‚è€ƒèµ„æ–™

- [Web Workers API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API)
- [Comlink åº“æ–‡æ¡£](https://github.com/GoogleChromeLabs/comlink)
- [JavaScript æ²™ç®±å®ç°](https://blog.risingstack.com/writing-a-javascript-framework-sandboxed-code-evaluation/)

## ğŸš¨ æ³¨æ„äº‹é¡¹

- Worker å†…éƒ¨ä¸èƒ½è®¿é—® window å¯¹è±¡
- SharedArrayBuffer éœ€è¦ç‰¹æ®Š HTTP å¤´æ”¯æŒ
- iOS Safari å¯¹ Worker æœ‰å†…å­˜é™åˆ¶
- è€ƒè™‘ Worker å¯åŠ¨æˆæœ¬ï¼Œå¯èƒ½éœ€è¦ Worker æ± 
- é”™è¯¯å †æ ˆä¿¡æ¯å¯èƒ½è¢«å®‰å…¨ç­–ç•¥è¿‡æ»¤