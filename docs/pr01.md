# 可编辑代码工作流 — 平台原型需求 PR（v1）

> **目标愿景**：打造一个平台，而不仅是前端工作流编辑器。用户从**想法/需求描述**出发，经由 AI 拆解为**最小可执行单元（MEU）**，自动生成节点并可运行/调试/修复。平台支持日志捕捉、版本管理、多节点串行测试，并能以 **Web Components / 微前端 / iframe** 动态嵌入到外部系统。最终平台可将链路封装为对外服务接口。

---

## 一、范围（Scope）

* **包含：**

  * **想法→蓝图**：用户输入业务需求或场景，AI 输出结构化需求蓝图。
  * **蓝图→流程**：AI 将蓝图拆解为流程（DAG），每个节点为 MEU。
  * **AI 节点生成**：自动生成节点 `handler` 源码 + 输入/输出示例。
  * **节点调试与运行**：静态校验、沙箱执行、日志捕捉、版本管理。
  * **AI 修复**：基于运行错误/日志/栈，AI 生成修复补丁（Diff 预览→应用→回滚）。
  * **多节点串行测试（实验）**：对子图进行顺序执行，展示链路结果与日志。
  * **运行中心（Run Center）**：集中观测 runId/chainId 的执行状态与趋势。
  * **平台化输出**：NodePage/FlowViewer 以组件方式动态嵌入。
* **排除（V1 非目标）**：多人协作、服务端沙箱、复杂权限体系、大规模调度。

---

## 二、用户故事

1. 作为用户，我输入业务想法，AI 生成需求蓝图。
2. 我点击“一键转流程”，AI 拆分成节点 DAG 并生成代码初稿。
3. 我在画布上编辑节点，进入 NodePage 进行运行与调试。
4. 节点报错时，AI 给出修复方案（补丁 + 说明），我可一键应用或回滚。
5. 我能选择子图串行运行，查看链路输入/输出与日志。
6. 稳定链路能发布为服务接口，并嵌入到其他平台或门户。

---

## 三、架构分层

* **节点架构（核心）**：

  * **节点类型**：统一为自定义代码节点（CodeNode），每个节点即最小可执行单元（MEU）。
  * **节点组成**：

    * 元信息：`id`、`label`、`description`、`status`。
    * 代码区：`code`（必须导出 `handler`）、`language`（默认 js/ts）。
    * 数据区：`sampleInput`、`expectedOutput`、`schema`（可选类型约束）。
    * 运行态：`lastRun`（状态、耗时、输入/输出预览）、`logs` 引用、`versions`。
    * 控制参数：`timeoutMs`、`retries`、`executionMode`（单步/串行/并行）。
  * **节点生命周期**：

    1. 创建：AI/用户生成初稿。
    2. 校验：静态校验语法与导出函数。
    3. 执行：Worker 内运行，捕捉日志与错误。
    4. 观测：Run Center 汇总状态、耗时、日志。
    5. 修复：AI 基于错误上下文生成补丁。
    6. 版本：保存代码版本与运行快照，可回滚。
  * **节点交互**：支持独立 NodePage 调试，也可在 FlowCanvas 中编排连线。

* **Ideas 蓝图层**：需求描述输入 + 蓝图输出（大纲 + 关系图）。

* **Planner 流程层**：蓝图 → DAG 节点；支持人工微调。

* **Flow Studio**：React Flow 画布 + 节点抽屉（代码/运行/日志/版本/AI 修复）。

* **Node Studio（NodePage）**：独立路由 `/nodes/:nodeId`，支持嵌入与独立调试。

* **Runner 沙箱层**：Web Worker 隔离执行，禁用敏感 API，日志流与错误捕捉。

* **AI 助手**：节点生成、报错修复、蓝图规划、优化建议。

* **嵌入层**：Web Components（推荐）、Module Federation、iframe。

---

## 四、核心功能

* **AI 生节点**：生成可运行的 `handler`，含示例输入/输出。
* **AI 修复**：运行失败时，AI 结合日志与栈输出最小差异补丁。
* **日志捕捉与保存**：DEBUG/INFO/WARN/ERROR 四级；内存缓存 + localStorage 持久化；支持 NDJSON 导出。
* **版本管理**：代码版本与运行快照；支持 Diff、回滚、固定版本运行。
* **串行测试链路**：子图拓扑执行，chainId 贯穿各节点 runId。
* **动态嵌入**：

  * `<workflow-node>`：独立节点页，可运行，可回传日志。
  * `<workflow-flow>`：流程视图，可展示与执行子图。

---

## 五、原型优先路线

* **P0（原型，2–3 天）**：

  * Ideas → 蓝图 → Flow 基础闭环。
  * NodePage：编辑器、运行、日志、AI 生成/修复、版本。
  * Web Components：输出 `<workflow-node>` 与 `<workflow-flow>` MVP。
  * 持久化：localStorage；导入/导出（不含运行历史）。
* **P1（随后 2 天）**：

  * Run Center：链路观测、错误热力。
  * Web Components 属性/事件补齐（主题、只读等）。
  * 版本 Diff、固定版本运行。
* **P2**：

  * 服务化接口：稳定链路封装为 API。
  * 嵌入安全策略：origin 白名单、消息签名。
  * AI 优化：性能调优、蓝图对齐。

---

## 六、页面 UI 描述

### 编辑页面（包含 Ideas、Planner、Flow Studio、Node Studio）

#### 首页（Ideas / 蓝图）

* **顶部区域**：需求输入表单（目标、约束、数据源、期望输出），支持富文本/多区块。
* **中间区域**：AI 输出的需求蓝图（Markdown + 结构化卡片 + 简图关系图）。
* **右侧操作**：一键转为流程按钮、AI 重新规划、导出蓝图。

#### Planner 流程页

* **左侧栏**：AI 给出的节点清单、依赖关系、I/O 概览。
* **主画布**：React Flow DAG，支持拖拽节点、连线、删除、复制。
* **右侧栏**：节点建议详情、接受/拒绝/拆分/合并操作。

#### Flow Studio

* **上方工具栏**：新增节点、保存、导入/导出、串行测试。
* **画布区**：节点/边展示；状态徽标（未验证/通过/错误/运行中）。
* **右侧抽屉**（节点选中时）：

  * 基本信息：节点名、描述。
  * 代码编辑：CodeMirror 编辑器。
  * 示例输入：JSON 编辑框。
  * 运行控制：超时设置、运行按钮。
  * 日志面板：按级别过滤，NDJSON 导出。
  * 版本管理：版本树、Diff、回滚。
  * AI 修复：显示补丁、解释、一键应用。

#### Node Studio（独立节点页）

* **头部**：节点标题、状态、快捷操作（运行、保存、导出）。
* **左侧**：运行配置（输入、超时、选项）。
* **中部**：代码编辑器（语法高亮、片段插入）。
* **右侧**：日志与错误栈展示；AI 修复面板。
* **底部**：运行时间线（输入/输出预览、耗时统计）
* **头部**：节点标题、状态、快捷操作（运行、保存、导出）。
* **左侧**：运行配置（输入、超时、选项）。
* **中部**：代码编辑器（语法高亮、片段插入）。
* **右侧**：日志与错误栈展示；AI 修复面板。
* **底部**：运行时间线（输入/输出预览、耗时统计）。

### 6.5 Run Center（运行中心）

* **列表视图**：运行记录（runId、状态、开始时间、耗时）。
* **筛选器**：状态/时间范围/节点/chainId。
* **详情面板**：日志流、输入/输出预览、错误详情、版本关联。
* **趋势分析**：错误热力图、链路耗时曲线。

### 6.6 嵌入组件 UI

* `<workflow-node>`：嵌入式卡片 UI，含运行按钮、日志面板。
* `<workflow-flow>`：只读画布，支持子图运行，右上角显示运行结果。

---

## 七、页面关系示意图（简化版）

```text
[首页 Ideas] --> [Planner 流程] --> [Flow Studio]
                                  |--(节点双击)--> [Node Studio]

[Flow Studio] -- 串行测试 --> [Run Center]

所有页面共享：日志面板、版本管理、AI 生成/修复

嵌入出口：<workflow-node> / <workflow-flow>
```

---

## 八、方向与结论

* **切入点**：先实现“想法→蓝图→节点→运行/修复/嵌入”的闭环原型，快速展示平台价值。
* **嵌入轨道**：推荐以 Web Components 为首选，后续兼顾微前端与 iframe。
* **长期路线**：逐步演进至服务化调用、权限体系与分布式执行。
