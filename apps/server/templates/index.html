{% extends 'base.html' %}
{% block content %}
<div class="row" style="align-items:center; margin-bottom:8px">
  <h2 style="margin:0">AgentOS 管理台 <span class="badge primary">最小闭环</span></h2>
  <span class="spacer"></span>
  <span id="tabHint" class="hint"></span>
  <span id="loadingSpin" class="spinner" style="display:none"></span>
</div>
<div id="tabs" style="margin-bottom:8px">
  <button class="tab active" data-path="/embed/run">运行</button>
  <button class="tab" data-path="/embed/episodes">Episodes</button>
  <button class="tab" data-path="/embed/scores">Scores</button>
</div>
<div id="tabContent" class="card slide-up" style="min-height:60vh"></div>
<script>
  const tabs = document.querySelectorAll('#tabs .tab');
  const content = document.getElementById('tabContent');
  const hint = document.getElementById('tabHint');
  const loading = document.getElementById('loadingSpin');
  async function load(path){
    hint.textContent = '加载中…';
    if(loading) loading.style.display = 'inline-block';
    const r = await fetch(path);
    const html = await r.text();
    content.innerHTML = html;
    hint.textContent = '';
    if(loading) loading.style.display = 'none';
    bindHandlers();
  }
  async function pollRun(jobId, outEl, btn){
    while(true){
      await new Promise(r=>setTimeout(r,1000));
      const r = await fetch('/api/run/status?job_id='+encodeURIComponent(jobId));
      const st = await r.json();
      if(st.done){
        const tid = (st.result && st.result.trace_id) ? st.result.trace_id : st.trace_id;
        if(tid){
          outEl.innerHTML = '运行完成，trace: <a href="/episodes/'+tid+'" target="_blank">'+tid+'</a>';
          const pre = document.createElement('pre');
          pre.textContent = JSON.stringify(st.result || st, null, 2);
          outEl.appendChild(pre);
        } else {
          outEl.textContent = JSON.stringify(st.result || st, null, 2);
        }
        if(btn) btn.disabled = false;
        return;
      }
      outEl.textContent = '运行中…(job '+jobId+')';
    }
  }
  function bindHandlers(){
    // 运行页拦截提交，避免跳转
    const form = content.querySelector('#runForm');
    if(form && form.dataset.managed !== 'true'){
      const outEl = content.querySelector('#runResult');
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const btn = form.querySelector('button[type="submit"]');
        if(btn) btn.disabled = true;
        if(outEl) outEl.innerHTML = '<span class="spinner"></span> 启动中…';
        const fd = new FormData(form);
        const resp = await fetch(form.action, {method:'POST', body:fd});
        const data = await resp.json();
        if(!data.ok){ if(outEl) outEl.textContent = JSON.stringify(data,null,2); if(btn) btn.disabled=false; return; }
        if(data.job_id){ pollRun(data.job_id, outEl, btn); }
      }, { once:false });
    }
    // Scores 筛选：阻止默认跳转，改为局部刷新
    const sf = content.querySelector('#scoreFilter');
    if(sf){
      sf.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const q = new URLSearchParams(new FormData(sf)).toString();
        await load('/embed/scores?'+q);
      });
      const qstr = ()=> new URLSearchParams(new FormData(sf)).toString();
      const dlCsv = content.querySelector('#dlGroupCsv');
      const dlHtml = content.querySelector('#dlHtml');
      if(dlCsv){ dlCsv.addEventListener('click', (e)=>{ e.preventDefault(); location.href='/api/scores/group.csv?'+qstr(); }); }
      if(dlHtml){ dlHtml.addEventListener('click', (e)=>{ e.preventDefault(); location.href='/api/scores/report.html?'+qstr(); }); }
      const dlDetail = content.querySelector('#dlDetailCsv');
      if(dlDetail){ dlDetail.addEventListener('click', (e)=>{ e.preventDefault(); location.href='/api/scores/detail.csv?'+qstr(); }); }
    }
    // Episodes 快捷操作
    content.querySelectorAll('.btn-replay').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const tid = btn.getAttribute('data-trace');
        const fd = new FormData(); fd.append('trace_id', tid);
        const r = await fetch('/api/replay', {method:'POST', body:fd});
        const data = await r.json();
        hint.textContent = data.ok ? ('回放: score='+data.result.score+' pass='+data.result.pass) : '回放失败';
        setTimeout(()=>hint.textContent='', 3000);
        // 刷新列表
        await load('/embed/episodes');
      });
    });
    content.querySelectorAll('.btn-rerun').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const tid = btn.getAttribute('data-trace');
        const out = 'reports/replay_'+tid+'.md';
        const fd = new FormData(); fd.append('trace_id', tid); fd.append('out_path', out);
        const r = await fetch('/api/rerun', {method:'POST', body:fd});
        const data = await r.json();
        hint.textContent = data.ok ? ('复跑完成: '+(data.result.out||'')) : '复跑失败';
        setTimeout(()=>hint.textContent='', 3000);
        await load('/embed/episodes');
      });
    });
  }
  tabs.forEach(btn => btn.addEventListener('click', () => {
    tabs.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    load(btn.dataset.path);
  }));
  // 支持通过 ?tab=run|episodes|scores 选择默认页
  const usp = new URLSearchParams(location.search);
  const tab = usp.get('tab') || 'run';
  const map = { run:'/embed/run', episodes:'/embed/episodes', scores:'/embed/scores' };
  const def = map[tab] || '/embed/run';
  if(tab!=='run'){
    tabs.forEach(b=>{ if(b.dataset.path===def){ b.classList.add('active'); } else { b.classList.remove('active'); }});
  }
  load(def);
</script>
{% endblock %}
