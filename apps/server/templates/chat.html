{% extends 'base.html' %}
{% block content %}
<div class="row" style="align-items:center; margin-bottom:8px">
  <h2 style="margin:0">Chat</h2>
  <span class="spacer"></span>
  <button id="btnWs" class="btn ghost">📁 工作区</button>
  <button id="btnTools" class="btn ghost">🔧 工具</button>
  <span id="chatHint" class="hint"></span>
  <span id="chatSpin" class="spinner" style="display:none"></span>
</div>

<div class="chat-layout" id="chatLayout">
  <div class="chat-main">
    <div id="chatBox" class="chat-box"></div>
    <form id="chatForm" class="sticky-input" method="post" action="/api/chat/send">
      <input type="hidden" name="session" id="chatSession">
      <input name="text" style="width:70%" placeholder="请输入需求…"> <button type="submit">发送</button>
      <div class="hint" style="margin-top:4px">提示：描述你的需求可生成 SRS 草稿或运行建议。点击右上“工作区”可浏览/编辑文件并插入到对话。</div>
    </form>
    <div id="actionBox" class="card"></div>
    <div id="toolsPanel" class="card" style="display:none"></div>
  </div>
  <aside class="task-sidebar">
    <div class="card" id="taskPanel">
      <div class="task-panel-header">
        <h3>任务列表</h3>
        <button id="refreshTasks" class="btn ghost small">刷新</button>
      </div>
      <div class="hint">实时关注最小闭环的执行状态与审批请求。</div>
      <div id="budgetBanner" class="budget-banner">
        <div class="budget-title">预算提示</div>
        <div id="budgetMessage"></div>
        <div id="budgetPayload" class="budget-meta"></div>
        <div style="margin-top:6px; display:flex; justify-content:flex-end">
          <button id="budgetDismiss" class="btn ghost small">知道了</button>
        </div>
      </div>
      <div class="task-group" data-group="running">
        <div class="task-group-header">进行中</div>
        <div class="task-list" id="taskListRunning"></div>
        <div class="task-empty" id="taskEmptyRunning">暂无进行中任务</div>
      </div>
      <div class="task-group" data-group="approval">
        <div class="task-group-header">待审批</div>
        <div class="task-list" id="taskListApproval"></div>
        <div class="task-empty" id="taskEmptyApproval">暂无审批任务</div>
      </div>
      <div class="task-group" data-group="done">
        <div class="task-group-header">已完成</div>
        <div class="task-list" id="taskListDone"></div>
        <div class="task-empty" id="taskEmptyDone">暂无历史记录</div>
      </div>
    </div>
    <div class="card" id="taskDetailCard" style="display:none">
      <div class="task-detail-header">
        <div>
          <div id="taskDetailTitle">Episode</div>
          <div class="hint" id="taskDetailSubtitle"></div>
        </div>
        <button id="taskDetailClose" class="btn ghost small">关闭</button>
      </div>
      <div id="taskDetailBody" class="task-detail-body"></div>
    </div>
  </aside>
</div>

<!-- 工作区抽屉 -->
<div class="drawer" id="wsDrawer">
  <div class="backdrop"></div>
  <div class="drawer-panel">
    <div class="drawer-header">
      <b>Workspace</b>
      <input id="wsToken" placeholder="Admin Token(可选)" style="flex:1; max-width:220px">
      <button id="btnCloseWs" class="btn ghost">关闭</button>
    </div>
    <div class="drawer-body">
      <div class="hint">当前: <span id="wsCwd"></span></div>
      <div id="wsTree" style="margin-top:6px"></div>
      <hr>
      <div id="wsPreviewWrap" style="display:none">
        <div style="margin-bottom:6px"><span id="wsSel"></span></div>
        <textarea id="wsContent" style="height:200px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace"></textarea>
        <div style="margin-top:6px">
          <button id="btnInsert">插入到对话</button>
          <button id="btnSave">保存</button>
          <span id="wsHint" class="hint" style="margin-left:6px"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 审批弹窗 -->
<div class="modal" id="approvalModal" aria-hidden="true">
  <div class="modal-backdrop"></div>
  <div class="modal-panel">
    <div class="modal-header">
      <span>审批请求</span>
      <button id="approvalClose" class="btn ghost small">关闭</button>
    </div>
    <div class="modal-body">
      <div id="approvalMessage"></div>
      <pre id="approvalPayload" style="display:none"></pre>
    </div>
    <div class="modal-actions">
      <button class="btn danger" data-action="reject">终止任务</button>
      <button class="btn ghost" data-action="downgrade">降级执行</button>
      <button class="btn" data-action="approve">继续执行</button>
    </div>
  </div>
</div>

<script type="module" src="{{ url_for('static', path='chat/index.js') }}"></script>
{% endblock %}
