{% extends 'base.html' %}
{% block content %}
<h2>Chat</h2>
<div id="chatBox" style="border:1px solid #ddd; padding:8px; height:60vh; overflow:auto; background:#fff"></div>
<form id="chatForm" method="post" action="/api/chat/send" style="margin-top:8px">
  <input type="hidden" name="session" id="chatSession">
  <input name="text" style="width:70%" placeholder="请输入需求…"> <button type="submit">发送</button>
  <span id="chatHint" style="margin-left:8px;color:#666"></span>
  <div style="color:#999; font-size:12px; margin-top:4px">提示：你可以描述一个需求，我会生成 SRS 草稿或建议如何在运行页执行。</div>
</form>
<div id="actionBox" style="margin-top:8px"></div>
<script>
const box = document.getElementById('chatBox');
const form = document.getElementById('chatForm');
const sess = document.getElementById('chatSession');
const hint = document.getElementById('chatHint');
const actionBox = document.getElementById('actionBox');
if(!sess.value){ sess.value = 's-'+Math.random().toString(16).slice(2,10); }
function append(role, text){
  const div = document.createElement('div');
  div.style.margin='6px 0';
  div.innerHTML = '<b>'+role+':</b> ' + text.replace(/\n/g,'<br>');
  box.appendChild(div); box.scrollTop = box.scrollHeight;
}
async function loadHistory(){
  const resp = await fetch('/api/chat/history?session='+encodeURIComponent(sess.value));
  const data = await resp.json();
  if(data.ok){
    box.innerHTML='';
    for(const m of data.history){ append(m.role==='user'?'你':'助手', m.content); }
  }
}
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(form);
  const text = fd.get('text');
  if(!text) return;
  append('你', String(text));
  form.text.value=''; hint.textContent='思考中…';
  const resp = await fetch(form.action, {method:'POST', body:fd});
  const data = await resp.json();
  hint.textContent='';
  if(data.ok){ append('助手', data.reply); }
  else{ append('系统', '发送失败'); }
  // 渲染 action 卡片
  actionBox.innerHTML='';
  if(data.action && data.action.type==='run'){
    const args = data.action.args || {};
    const div = document.createElement('div');
    div.style.border='1px solid #ddd'; div.style.padding='8px'; div.style.background='#fff';
    div.innerHTML = '<b>执行建议</b> — type=run' +
      '<div>args: <pre>'+JSON.stringify(args,null,2)+'</pre></div>' +
      (data.srs_path?('<div>SRS 已保存: '+data.srs_path+'</div>'):'') +
      '<button id="btnRunNow">立即运行</button>';
    actionBox.appendChild(div);
    const btn = div.querySelector('#btnRunNow');
    btn.addEventListener('click', async ()=>{
      const fd2 = new FormData();
      fd2.append('srs_path', args.srs_path || 'examples/srs/weekly_report.json');
      fd2.append('data_path', args.data_path || 'examples/data/weekly.csv');
      fd2.append('out_path', args.out || 'reports/weekly_report.md');
      fd2.append('planner', args.planner || 'llm');
      fd2.append('executor', args.executor || 'llm');
      fd2.append('critic', args.critic || 'llm');
      fd2.append('reviser', args.reviser || 'llm');
      if(args.provider) fd2.append('provider', args.provider);
      hint.textContent='开始执行…';
      const r2 = await fetch('/api/run', {method:'POST', body:fd2});
      const j2 = await r2.json();
      hint.textContent = j2.ok ? ('已提交，job='+ (j2.job_id||'')) : '提交失败';
    });
  }
});
// 首次加载历史
loadHistory();
</script>
{% endblock %}
