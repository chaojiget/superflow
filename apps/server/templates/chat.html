{% extends 'base.html' %}
{% block content %}
<div class="row" style="align-items:center; margin-bottom:8px">
  <h2 style="margin:0">Chat</h2>
  <span class="spacer"></span>
  <button id="btnWs" class="btn ghost">📁 工作区</button>
  <button id="btnTools" class="btn ghost">🔧 工具</button>
  <span id="chatHint" class="hint"></span>
  <span id="chatSpin" class="spinner" style="display:none"></span>
</div>

<div id="chatPane">
  <div id="chatBox" class="chat-box"></div>
  <form id="chatForm" class="sticky-input" method="post" action="/api/chat/send">
    <input type="hidden" name="session" id="chatSession">
    <input name="text" style="width:70%" placeholder="请输入需求…"> <button type="submit">发送</button>
    <div class="hint" style="margin-top:4px">提示：描述你的需求可生成 SRS 草稿或运行建议。点击右上“工作区”可浏览/编辑文件并插入到对话。</div>
  </form>
  <div id="actionBox" class="card" style="margin-top:8px"></div>
  <div id="toolsPanel" class="card" style="margin-top:8px; display:none"></div>
</div>

<!-- 工作区抽屉 -->
<div class="drawer" id="wsDrawer">
  <div class="backdrop"></div>
  <div class="drawer-panel">
    <div class="drawer-header">
      <b>Workspace</b>
      <input id="wsToken" placeholder="Admin Token(可选)" style="flex:1; max-width:220px">
      <button id="btnCloseWs" class="btn ghost">关闭</button>
    </div>
    <div class="drawer-body">
      <div class="hint">当前: <span id="wsCwd"></span></div>
      <div id="wsTree" style="margin-top:6px"></div>
      <hr>
      <div id="wsPreviewWrap" style="display:none">
        <div style="margin-bottom:6px"><span id="wsSel"></span></div>
        <textarea id="wsContent" style="height:200px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace"></textarea>
        <div style="margin-top:6px">
          <button id="btnInsert">插入到对话</button>
          <button id="btnSave">保存</button>
          <span id="wsHint" class="hint" style="margin-left:6px"></span>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
const box = document.getElementById('chatBox');
const form = document.getElementById('chatForm');
const sess = document.getElementById('chatSession');
const hint = document.getElementById('chatHint');
const spin = document.getElementById('chatSpin');
const actionBox = document.getElementById('actionBox');
const wsTree = document.getElementById('wsTree');
const wsCwd = document.getElementById('wsCwd');
const wsPreviewWrap = document.getElementById('wsPreviewWrap');
const wsSel = document.getElementById('wsSel');
const wsContent = document.getElementById('wsContent');
const wsHint = document.getElementById('wsHint');
const wsToken = document.getElementById('wsToken');
const wsDrawer = document.getElementById('wsDrawer');
const btnWs = document.getElementById('btnWs');
const btnTools = document.getElementById('btnTools');
const btnCloseWs = document.getElementById('btnCloseWs');
const wsBackdrop = wsDrawer?.querySelector('.backdrop');
if(!sess.value){ sess.value = 's-'+Math.random().toString(16).slice(2,10); }

let eventSocket = null;
let eventRetryTimer = null;
let wsConnected = false;

// Chat 区域
function fmtTime(ts){
  if(ts){
    try{
      const d = new Date(ts);
      if(!isNaN(d.getTime())){ return d.toTimeString().slice(0,5); }
    }catch(e){}
  }
  const d = new Date();
  return d.toTimeString().slice(0,5);
}
function append(role, text, ts){
  const normalized = role === '你' ? 'user' : (role === '助手' ? 'assistant' : (role || 'system'));
  const me = normalized === 'user';
  const wrap = document.createElement('div');
  wrap.className = 'msg'+(me?' user':'');
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  let label = '系统';
  if(normalized === 'user'){ label = '你'; }
  else if(normalized === 'assistant'){ label = '助手'; }
  else if(normalized === 'system'){ label = '系统'; }
  else { label = normalized; }
  bubble.innerHTML = '<b>'+label+'</b> · <span class="meta">'+fmtTime(ts)+'</span><br>' + String(text||'').replace(/\n/g,'<br>');
  wrap.appendChild(bubble);
  box.appendChild(wrap); box.scrollTop = box.scrollHeight;
  return wrap;
}
function renderHistory(list){
  if(!Array.isArray(list)) return;
  box.innerHTML='';
  for(const m of list){
    append(m.role || 'assistant', m.content, m.ts);
  }
}
function handleStatus(state, message){
  if(!hint) return;
  if(state === 'thinking' || state === 'pending'){
    hint.textContent = message || '思考中…';
    if(spin) spin.style.display='inline-block';
  } else if(state === 'idle' || state === 'done'){
    hint.textContent = message || '';
    if(spin) spin.style.display='none';
  } else if(state === 'connecting'){
    hint.textContent = message || '事件连接中…';
    if(spin) spin.style.display='inline-block';
  } else if(state === 'error'){
    hint.textContent = message || '发生错误';
    if(spin) spin.style.display='none';
  } else if(state === 'connected'){
    hint.textContent = message || '';
    if(spin) spin.style.display='none';
  }
}
function renderAction(action, extras){
  if(!actionBox) return;
  actionBox.innerHTML='';
  if(!action || !action.type) return;
  if(action.type === 'run'){
    const args = action.args || {};
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = '<b>执行建议</b> — type=run'
      + '<div>args: <pre>'+JSON.stringify(args,null,2)+'</pre></div>'
      + (extras && extras.srs_path ? ('<div>SRS 已保存: '+extras.srs_path+'</div>') : '')
      + '<button id="btnRunNow">立即运行</button> <button id="btnEditRun">编辑并运行</button>';
    actionBox.appendChild(div);
    const btn = div.querySelector('#btnRunNow');
    if(btn){
      btn.addEventListener('click', async ()=>{
        const fd2 = new FormData();
        fd2.append('srs_path', args.srs_path || 'examples/srs/weekly_report.json');
        fd2.append('data_path', args.data_path || 'examples/data/weekly.csv');
        fd2.append('out_path', args.out || 'reports/weekly_report.md');
        fd2.append('planner', args.planner || 'llm');
        fd2.append('executor', args.executor || 'llm');
        fd2.append('critic', args.critic || 'llm');
        fd2.append('reviser', args.reviser || 'llm');
        if(args.provider) fd2.append('provider', args.provider);
        handleStatus('pending', '开始执行…');
        try{
          const r2 = await fetch('/api/run', {method:'POST', body:fd2});
          const j2 = await r2.json();
          handleStatus('idle', j2.ok ? ('已提交，job='+ (j2.job_id||'')) : '提交失败');
        }catch(err){
          handleStatus('error', '提交失败: '+err);
        }
      });
    }
    const btnEdit = div.querySelector('#btnEditRun');
    if(btnEdit){
      btnEdit.addEventListener('click', ()=>{
        try{ localStorage.setItem('runArgs', JSON.stringify(args)); }catch(e){}
        location.href = '/?tab=run';
      });
    }
  } else {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = '<b>动作</b><div class="hint">类型: '+action.type+'</div>';
    actionBox.appendChild(div);
  }
}
async function loadHistory(){
  const resp = await fetch('/api/chat/history?session='+encodeURIComponent(sess.value));
  const data = await resp.json();
  if(data.ok){
    renderHistory(data.history);
  }
}
function connectEvents(){
  if(eventRetryTimer){ clearTimeout(eventRetryTimer); eventRetryTimer = null; }
  if(eventSocket){
    try{ eventSocket.close(); }catch(e){}
    eventSocket = null;
  }
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  const url = `${proto}://${location.host}/agent/events?session=${encodeURIComponent(sess.value)}`;
  handleStatus('connecting', '事件连接中…');
  try{
    eventSocket = new WebSocket(url);
  }catch(err){
    handleStatus('error', '无法连接事件流');
    eventRetryTimer = setTimeout(connectEvents, 4000);
    return;
  }
  eventSocket.onopen = ()=>{ wsConnected = true; handleStatus('connected', ''); };
  eventSocket.onmessage = (ev)=>{
    try{
      const msg = JSON.parse(ev.data);
      if(msg.type === 'chat.init'){
        renderHistory(msg.history || []);
        renderAction(msg.action, msg);
        return;
      }
      if(msg.type === 'chat.message'){
        append(msg.role || 'assistant', msg.content, msg.ts);
        renderAction(msg.action, msg);
        if(msg.role === 'assistant'){ handleStatus('idle', ''); }
        return;
      }
      if(msg.type === 'chat.status'){
        handleStatus(msg.state, msg.message);
        return;
      }
      if(msg.type === 'chat.action'){
        renderAction(msg.action, msg);
        return;
      }
      if(msg.type === 'chat.error'){
        append('system', msg.message || '连接异常', msg.ts);
        handleStatus('error', msg.message);
        return;
      }
      if(msg.type === 'error'){
        append('system', msg.message || '事件错误', msg.ts);
        handleStatus('error', msg.message);
        return;
      }
      if(msg.type === 'ping'){
        try{ eventSocket?.send(JSON.stringify({type:'pong'})); }catch(e){}
        return;
      }
    }catch(err){ console.warn('ws message parse fail', err); }
  };
  eventSocket.onclose = ()=>{
    wsConnected = false;
    handleStatus('error', '事件连接断开，准备重试…');
    if(!eventRetryTimer){
      eventRetryTimer = setTimeout(connectEvents, 2000);
    }
  };
  eventSocket.onerror = ()=>{ try{ eventSocket?.close(); }catch(e){}; };
}
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(form);
  const text = fd.get('text');
  if(!text) return;
  if(!wsConnected){ append('user', String(text), new Date().toISOString()); }
  form.text.value='';
  handleStatus('thinking', '思考中…');
  try{
    const resp = await fetch(form.action, {method:'POST', body:fd});
    const data = await resp.json();
    if(!data.ok){
      handleStatus('error', data.error || '发送失败');
      append('system', data.error || '发送失败', new Date().toISOString());
    } else if(!wsConnected){
      append('assistant', data.reply, new Date().toISOString());
      renderAction(data.action, data);
      handleStatus('idle', '');
    }
  }catch(err){
    handleStatus('error', '发送失败: '+err);
    append('system', '发送失败: '+err, new Date().toISOString());
  }
});

// Workspace 区域
async function wsLs(path){
  const r = await fetch('/api/ws/ls?path='+encodeURIComponent(path||'.'));
  return await r.json();
}
async function wsRead(path){
  const r = await fetch('/api/ws/read?path='+encodeURIComponent(path));
  return await r.json();
}
async function wsWrite(path, content){
  const fd = new FormData(); fd.append('path', path); fd.append('content', content);
  const headers = {};
  if(wsToken.value){ headers['X-Admin-Token'] = wsToken.value; }
  const r = await fetch('/api/ws/write', {method:'POST', body:fd, headers});
  return await r.json();
}
function renderTree(cwd, dirs, files){
  wsCwd.textContent = cwd || '/';
  const ul = document.createElement('ul'); ul.style.listStyle='none'; ul.style.paddingLeft='0';
  const up = document.createElement('li');
  up.innerHTML = '<a href="#">..</a>';
  up.addEventListener('click', (e)=>{ e.preventDefault(); const parent = cwd? cwd.split('/').slice(0,-1).join('/') : ''; loadDir(parent); });
  ul.appendChild(up);
  for(const d of dirs){
    const li = document.createElement('li'); li.innerHTML = '📁 <a href="#">'+d+'</a>';
    li.querySelector('a').addEventListener('click', (e)=>{ e.preventDefault(); loadDir((cwd?cwd+'/':'')+d); });
    ul.appendChild(li);
  }
  for(const f of files){
    const li = document.createElement('li'); li.innerHTML = '📄 <a href="#">'+f.name+'</a> <span style="color:#999; font-size:12px">('+ (f.size||'') +')</span>';
    li.querySelector('a').addEventListener('click', async (e)=>{ e.preventDefault(); const rel = (cwd?cwd+'/':'')+f.name; const j = await wsRead(rel); if(j.ok){ wsPreviewWrap.style.display='block'; wsSel.textContent = rel; wsContent.value = j.content; wsHint.textContent=''; } else { wsHint.textContent = j.error||'读取失败'; }});
    ul.appendChild(li);
  }
  wsTree.innerHTML=''; wsTree.appendChild(ul);
}
async function loadDir(path){
  const j = await wsLs(path||'.');
  if(j.ok){ renderTree(j.cwd, j.dirs||[], j.files||[]); }
}
document.getElementById('btnInsert')?.addEventListener('click', ()=>{
  if(!wsSel.textContent) return;
  const text = '请参考文件 '+wsSel.textContent+" 的内容：\n\n```\n"+wsContent.value+"\n```\n";
  form.text.value = text;
});
document.getElementById('btnSave')?.addEventListener('click', async ()=>{
  const p = wsSel.textContent; if(!p) return;
  wsHint.textContent = '保存中…';
  const j = await wsWrite(p, wsContent.value);
  wsHint.textContent = j.ok ? '已保存' : ('保存失败: '+(j.error||''));
  setTimeout(()=>{ wsHint.textContent=''; }, 2000);
});

// Drawer 交互
function openWs(){ wsDrawer?.classList.add('open'); }
function closeWs(){ wsDrawer?.classList.remove('open'); }
btnWs?.addEventListener('click', openWs);
btnCloseWs?.addEventListener('click', closeWs);
wsBackdrop?.addEventListener('click', closeWs);

// 首次加载
loadHistory();
connectEvents();
loadDir('examples');

// 工具面板
async function loadTools(server){
  const resp = await fetch('/api/mcp/tools?server='+(server||'api'));
  const j = await resp.json();
  const panel = document.getElementById('toolsPanel');
  if(!panel) return;
  if(!j.ok){ panel.style.display='block'; panel.innerHTML = '<b>工具</b><div class="hint">加载失败: '+(j.error||'')+'</div>'; return; }
  const serverId = j.server || 'api';
  let html = '<div style="display:flex;gap:8px;align-items:center"><b>工具</b><label>server:</label><input id="toolServer" value="'+serverId+'" style="width:120px"></div>';
  if(!j.tools || !j.tools.length){ html += '<div class="hint">无可用工具</div>'; panel.innerHTML = html; panel.style.display='block'; return; }
  html += '<div style="margin-top:6px">';
  for(const t of j.tools){
    const dn = (t.name||'');
    const desc = (t.description||'');
    html += '<div style="border-top:1px solid #eee; padding:6px 0">'
      + '<div><b>'+dn+'</b></div>'
      + (desc?('<div class="hint">'+desc+'</div>'):'')
      + '<div style="display:flex;gap:6px;align-items:center;margin-top:4px">'
      + '<span class="hint">args(JSON):</span>'
      + '<input id="arg_'+dn+'" style="flex:1" value="{}">'
      + '<button data-tool="'+dn+'">调用</button>'
      + '</div>'
      + '</div>';
  }
  html += '</div>';
  panel.innerHTML = html; panel.style.display='block';
  panel.querySelectorAll('button[data-tool]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const tool = btn.getAttribute('data-tool');
      const server = document.getElementById('toolServer').value || 'api';
      const argInput = document.getElementById('arg_'+tool);
      let argsJson = '{}';
      try{ argsJson = argInput.value || '{}'; }catch(e){}
      const fd = new FormData(); fd.append('server', server); fd.append('tool', tool); fd.append('args_json', argsJson);
      hint.textContent='执行 '+tool+'…'; if(spin) spin.style.display='inline-block';
      try{
        const resp2 = await fetch('/api/mcp/call', {method:'POST', body: fd});
        const j2 = await resp2.json();
        if(j2.ok){
          const res = j2.result || {}; const txt = res.text || (res.structured?JSON.stringify(res.structured):'');
          append('助手', '[MCP '+server+'.'+tool+']\n'+(txt||'<no result>'));
        } else {
          append('系统', '调用失败: '+(j2.error||''));
        }
      }catch(e){
        append('系统', '调用失败: '+String(e));
      } finally {
        hint.textContent=''; if(spin) spin.style.display='none';
      }
    });
  });
}
btnTools?.addEventListener('click', ()=>{
  const panel = document.getElementById('toolsPanel');
  if(panel.style.display==='none'){ loadTools('api'); }
  else { panel.style.display='none'; }
});
</script>
{% endblock %}
