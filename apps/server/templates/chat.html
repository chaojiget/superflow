{% extends 'base.html' %}
{% block content %}
<div class="row" style="align-items:center; margin-bottom:8px">
  <h2 style="margin:0">Chat</h2>
  <span class="spacer"></span>
  <button id="btnWs" class="btn ghost">ğŸ“ å·¥ä½œåŒº</button>
  <span id="chatHint" class="hint"></span>
  <span id="chatSpin" class="spinner" style="display:none"></span>
</div>

<div id="chatPane">
  <div id="chatBox" class="chat-box"></div>
  <form id="chatForm" class="sticky-input" method="post" action="/api/chat/send">
    <input type="hidden" name="session" id="chatSession">
    <input name="text" style="width:70%" placeholder="è¯·è¾“å…¥éœ€æ±‚â€¦"> <button type="submit">å‘é€</button>
    <div class="hint" style="margin-top:4px">æç¤ºï¼šæè¿°ä½ çš„éœ€æ±‚å¯ç”Ÿæˆ SRS è‰ç¨¿æˆ–è¿è¡Œå»ºè®®ã€‚ç‚¹å‡»å³ä¸Šâ€œå·¥ä½œåŒºâ€å¯æµè§ˆ/ç¼–è¾‘æ–‡ä»¶å¹¶æ’å…¥åˆ°å¯¹è¯ã€‚</div>
  </form>
  <div id="actionBox" class="card" style="margin-top:8px"></div>
</div>

<!-- å·¥ä½œåŒºæŠ½å±‰ -->
<div class="drawer" id="wsDrawer">
  <div class="backdrop"></div>
  <div class="drawer-panel">
    <div class="drawer-header">
      <b>Workspace</b>
      <input id="wsToken" placeholder="Admin Token(å¯é€‰)" style="flex:1; max-width:220px">
      <button id="btnCloseWs" class="btn ghost">å…³é—­</button>
    </div>
    <div class="drawer-body">
      <div class="hint">å½“å‰: <span id="wsCwd"></span></div>
      <div id="wsTree" style="margin-top:6px"></div>
      <hr>
      <div id="wsPreviewWrap" style="display:none">
        <div style="margin-bottom:6px"><span id="wsSel"></span></div>
        <textarea id="wsContent" style="height:200px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace"></textarea>
        <div style="margin-top:6px">
          <button id="btnInsert">æ’å…¥åˆ°å¯¹è¯</button>
          <button id="btnSave">ä¿å­˜</button>
          <span id="wsHint" class="hint" style="margin-left:6px"></span>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
const box = document.getElementById('chatBox');
const form = document.getElementById('chatForm');
const sess = document.getElementById('chatSession');
const hint = document.getElementById('chatHint');
const spin = document.getElementById('chatSpin');
const actionBox = document.getElementById('actionBox');
const wsTree = document.getElementById('wsTree');
const wsCwd = document.getElementById('wsCwd');
const wsPreviewWrap = document.getElementById('wsPreviewWrap');
const wsSel = document.getElementById('wsSel');
const wsContent = document.getElementById('wsContent');
const wsHint = document.getElementById('wsHint');
const wsToken = document.getElementById('wsToken');
const wsDrawer = document.getElementById('wsDrawer');
const btnWs = document.getElementById('btnWs');
const btnCloseWs = document.getElementById('btnCloseWs');
const wsBackdrop = wsDrawer?.querySelector('.backdrop');
if(!sess.value){ sess.value = 's-'+Math.random().toString(16).slice(2,10); }

// Chat åŒºåŸŸ
function fmtTime(){ const d = new Date(); return d.toTimeString().slice(0,5); }
function append(role, text){
  const me = role === 'ä½ ' || role === 'user';
  const wrap = document.createElement('div');
  wrap.className = 'msg'+(me?' user':'');
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerHTML = (me?'<b>ä½ </b>':'<b>åŠ©æ‰‹</b>') + ' Â· <span class="meta">'+fmtTime()+'</span><br>' + String(text).replace(/\n/g,'<br>');
  wrap.appendChild(bubble);
  box.appendChild(wrap); box.scrollTop = box.scrollHeight;
}
async function loadHistory(){
  const resp = await fetch('/api/chat/history?session='+encodeURIComponent(sess.value));
  const data = await resp.json();
  if(data.ok){
    box.innerHTML='';
    for(const m of data.history){ append(m.role==='user'?'ä½ ':'åŠ©æ‰‹', m.content); }
  }
}
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(form);
  const text = fd.get('text');
  if(!text) return;
  append('ä½ ', String(text));
  form.text.value=''; hint.textContent='æ€è€ƒä¸­â€¦'; if(spin) spin.style.display='inline-block';
  const resp = await fetch(form.action, {method:'POST', body:fd});
  const data = await resp.json();
  hint.textContent=''; if(spin) spin.style.display='none';
  if(data.ok){ append('åŠ©æ‰‹', data.reply); }
  else{ append('ç³»ç»Ÿ', 'å‘é€å¤±è´¥'); }
  // æ¸²æŸ“ action å¡ç‰‡
  actionBox.innerHTML='';
  if(data.action && data.action.type==='run'){
    const args = data.action.args || {};
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = '<b>æ‰§è¡Œå»ºè®®</b> â€” type=run' +
      '<div>args: <pre>'+JSON.stringify(args,null,2)+'</pre></div>' +
      (data.srs_path?('<div>SRS å·²ä¿å­˜: '+data.srs_path+'</div>'):'') +
      '<button id="btnRunNow">ç«‹å³è¿è¡Œ</button> <button id="btnEditRun">ç¼–è¾‘å¹¶è¿è¡Œ</button>';
    actionBox.appendChild(div);
    const btn = div.querySelector('#btnRunNow');
    btn.addEventListener('click', async ()=>{
      const fd2 = new FormData();
      fd2.append('srs_path', args.srs_path || 'examples/srs/weekly_report.json');
      fd2.append('data_path', args.data_path || 'examples/data/weekly.csv');
      fd2.append('out_path', args.out || 'reports/weekly_report.md');
      fd2.append('planner', args.planner || 'llm');
      fd2.append('executor', args.executor || 'llm');
      fd2.append('critic', args.critic || 'llm');
      fd2.append('reviser', args.reviser || 'llm');
      if(args.provider) fd2.append('provider', args.provider);
      hint.textContent='å¼€å§‹æ‰§è¡Œâ€¦';
      const r2 = await fetch('/api/run', {method:'POST', body:fd2});
      const j2 = await r2.json();
      hint.textContent = j2.ok ? ('å·²æäº¤ï¼Œjob='+ (j2.job_id||'')) : 'æäº¤å¤±è´¥';
    });
    const btnEdit = div.querySelector('#btnEditRun');
    btnEdit.addEventListener('click', ()=>{
      try{ localStorage.setItem('runArgs', JSON.stringify(args)); }catch(e){}
      location.href = '/?tab=run';
    });
  }
});

// Workspace åŒºåŸŸ
async function wsLs(path){
  const r = await fetch('/api/ws/ls?path='+encodeURIComponent(path||'.'));
  return await r.json();
}
async function wsRead(path){
  const r = await fetch('/api/ws/read?path='+encodeURIComponent(path));
  return await r.json();
}
async function wsWrite(path, content){
  const fd = new FormData(); fd.append('path', path); fd.append('content', content);
  const headers = {};
  if(wsToken.value){ headers['X-Admin-Token'] = wsToken.value; }
  const r = await fetch('/api/ws/write', {method:'POST', body:fd, headers});
  return await r.json();
}
function renderTree(cwd, dirs, files){
  wsCwd.textContent = cwd || '/';
  const ul = document.createElement('ul'); ul.style.listStyle='none'; ul.style.paddingLeft='0';
  const up = document.createElement('li');
  up.innerHTML = '<a href="#">..</a>';
  up.addEventListener('click', (e)=>{ e.preventDefault(); const parent = cwd? cwd.split('/').slice(0,-1).join('/') : ''; loadDir(parent); });
  ul.appendChild(up);
  for(const d of dirs){
    const li = document.createElement('li'); li.innerHTML = 'ğŸ“ <a href="#">'+d+'</a>';
    li.querySelector('a').addEventListener('click', (e)=>{ e.preventDefault(); loadDir((cwd?cwd+'/':'')+d); });
    ul.appendChild(li);
  }
  for(const f of files){
    const li = document.createElement('li'); li.innerHTML = 'ğŸ“„ <a href="#">'+f.name+'</a> <span style="color:#999; font-size:12px">('+ (f.size||'') +')</span>';
    li.querySelector('a').addEventListener('click', async (e)=>{ e.preventDefault(); const rel = (cwd?cwd+'/':'')+f.name; const j = await wsRead(rel); if(j.ok){ wsPreviewWrap.style.display='block'; wsSel.textContent = rel; wsContent.value = j.content; wsHint.textContent=''; } else { wsHint.textContent = j.error||'è¯»å–å¤±è´¥'; }});
    ul.appendChild(li);
  }
  wsTree.innerHTML=''; wsTree.appendChild(ul);
}
async function loadDir(path){
  const j = await wsLs(path||'.');
  if(j.ok){ renderTree(j.cwd, j.dirs||[], j.files||[]); }
}
document.getElementById('btnInsert')?.addEventListener('click', ()=>{
  if(!wsSel.textContent) return;
  const text = 'è¯·å‚è€ƒæ–‡ä»¶ '+wsSel.textContent+" çš„å†…å®¹ï¼š\n\n```\n"+wsContent.value+"\n```\n";
  form.text.value = text;
});
document.getElementById('btnSave')?.addEventListener('click', async ()=>{
  const p = wsSel.textContent; if(!p) return;
  wsHint.textContent = 'ä¿å­˜ä¸­â€¦';
  const j = await wsWrite(p, wsContent.value);
  wsHint.textContent = j.ok ? 'å·²ä¿å­˜' : ('ä¿å­˜å¤±è´¥: '+(j.error||''));
  setTimeout(()=>{ wsHint.textContent=''; }, 2000);
});

// Drawer äº¤äº’
function openWs(){ wsDrawer?.classList.add('open'); }
function closeWs(){ wsDrawer?.classList.remove('open'); }
btnWs?.addEventListener('click', openWs);
btnCloseWs?.addEventListener('click', closeWs);
wsBackdrop?.addEventListener('click', closeWs);

// é¦–æ¬¡åŠ è½½
loadHistory();
loadDir('examples');
</script>
{% endblock %}
