<h2>运行最小闭环</h2>
<form id="runForm" method="post" action="/api/run">
  <div><label>SRS 路径: <input name="srs_path" value="examples/srs/weekly_report.json" style="width:420px"></label></div>
  <div><label>数据 CSV: <input name="data_path" value="examples/data/weekly.csv" style="width:420px"></label></div>
  <div><label>输出路径: <input name="out_path" value="reports/weekly_report.md" style="width:420px"></label></div>
  <div>
    <label>Planner: <select name="planner"><option>llm</option><option>rules</option></select></label>
    <label>Executor: <select name="executor"><option>llm</option><option>skills</option></select></label>
    <label>Critic: <select name="critic"><option>llm</option><option>rules</option></select></label>
    <label>Reviser: <select name="reviser"><option>llm</option><option>rules</option></select></label>
  </div>
  <div style="margin-top:8px">
    <label>Provider: 
      <select name="provider">
        <option value="openrouter" {% if cur_provider=='openrouter' %}selected{% endif %}>openrouter</option>
        <option value="openai" {% if cur_provider=='openai' %}selected{% endif %}>openai</option>
      </select>
    </label>
    <span id="providerHint" style="color:#666">将使用: {{cur_provider}}:{{cur_model}}</span>
  </div>
  <div style="margin-top:8px">
    <label>温度(Planner): <input name="temp_planner" type="number" step="0.1" min="0" max="2" placeholder="默认配置"></label>
    <label>温度(Executor): <input name="temp_executor" type="number" step="0.1" min="0" max="2" placeholder="默认配置"></label>
    <label>温度(Critic): <input name="temp_critic" type="number" step="0.1" min="0" max="2" placeholder="默认配置"></label>
    <label>温度(Reviser): <input name="temp_reviser" type="number" step="0.1" min="0" max="2" placeholder="默认配置"></label>
  </div>
  <div style="margin-top:8px">
    <label>重试次数: <input name="retries" type="number" min="0" placeholder="默认配置"></label>
    <label>CSV片段最大行数: <input name="max_rows" type="number" min="1" placeholder="默认配置"></label>
  </div>
  <div style="margin-top:8px"><button type="submit">运行</button></div>
</form>
<pre id="runResult" style="background:#f7f7f7; padding:8px; margin-top:8px"></pre>
<script>
const form = document.getElementById('runForm');
const el = document.getElementById('runResult');
async function poll(jobId){
  while(true){
    await new Promise(r=>setTimeout(r, 1000));
    const r = await fetch('/api/run/status?job_id='+encodeURIComponent(jobId));
    const st = await r.json();
    if(st.done){
      el.textContent = JSON.stringify(st.result || st, null, 2);
      form.querySelector('button[type="submit"]').disabled = false;
      return;
    }
    el.textContent = '运行中…(job ' + jobId + ')';
  }
}
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  form.querySelector('button[type="submit"]').disabled = true;
  el.textContent = '启动中…';
  const fd = new FormData(form);
  const resp = await fetch(form.action, { method: 'POST', body: fd });
  const data = await resp.json();
  if(!data.ok){ el.textContent = JSON.stringify(data,null,2); form.querySelector('button[type="submit"]').disabled=false; return; }
  if(data.job_id){ poll(data.job_id); }
});
// Provider 切换提示
const selProv = form.querySelector('select[name="provider"]');
if(selProv){
  selProv.addEventListener('change', ()=>{
    const hp = document.getElementById('providerHint');
    if(hp) hp.textContent = '将使用: ' + selProv.value + '（模型以配置为准）';
  });
}
</script>
