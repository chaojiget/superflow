<div class="card">
  <h3 style="margin-top:0">运行最小闭环</h3>
  <form id="runForm" method="post" action="/api/run">
    <div class="kv">
      <label for="srs_path">SRS 路径</label>
      <input id="srs_path" name="srs_path" type="text" value="examples/srs/weekly_report.json" placeholder="examples/srs/weekly_report.json" />

      <label for="data_path">数据 CSV</label>
      <input id="data_path" name="data_path" type="text" value="examples/data/weekly.csv" placeholder="examples/data/weekly.csv" />

      <label for="out_path">输出路径</label>
      <input id="out_path" name="out_path" type="text" value="reports/weekly_report.md" placeholder="reports/weekly_report.md" />

      <label>Planner</label>
      <select name="planner"><option>llm</option><option>rules</option></select>

      <label>Executor</label>
      <select name="executor"><option>llm</option><option>skills</option></select>

      <label>Critic</label>
      <select name="critic"><option>llm</option><option>rules</option></select>

      <label>Reviser</label>
      <select name="reviser"><option>llm</option><option>rules</option></select>

      <label>Provider</label>
      <div class="row">
        <select name="provider">
          <option value="openrouter" {% if cur_provider=='openrouter' %}selected{% endif %}>openrouter</option>
          <option value="openai" {% if cur_provider=='openai' %}selected{% endif %}>openai</option>
        </select>
        <span id="providerHint" class="hint" style="align-self:center">将使用: {{cur_provider}}:{{cur_model}}</span>
      </div>

      <label>温度(Planner)</label>
      <input name="temp_planner" type="number" step="0.1" min="0" max="2" placeholder="默认配置">

      <label>温度(Executor)</label>
      <input name="temp_executor" type="number" step="0.1" min="0" max="2" placeholder="默认配置">

      <label>温度(Critic)</label>
      <input name="temp_critic" type="number" step="0.1" min="0" max="2" placeholder="默认配置">

      <label>温度(Reviser)</label>
      <input name="temp_reviser" type="number" step="0.1" min="0" max="2" placeholder="默认配置">

      <label>重试次数</label>
      <input name="retries" type="number" min="0" placeholder="默认配置">

      <label>CSV片段最大行数</label>
      <input name="max_rows" type="number" min="1" placeholder="默认配置">
    </div>
    <div style="margin-top:12px"><button type="submit">▶ 运行</button></div>
  </form>
</div>

<div class="card" style="margin-top:12px">
  <div class="hint" style="margin-bottom:6px">运行输出</div>
  <pre id="runResult"></pre>
</div>
<script>
const form = document.getElementById('runForm');
const el = document.getElementById('runResult');
async function poll(jobId){
  while(true){
    await new Promise(r=>setTimeout(r, 1000));
    const r = await fetch('/api/run/status?job_id='+encodeURIComponent(jobId));
    const st = await r.json();
    if(st.done){
      el.textContent = JSON.stringify(st.result || st, null, 2);
      form.querySelector('button[type="submit"]').disabled = false;
      return;
    }
    el.textContent = '运行中…(job ' + jobId + ')';
  }
}
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  form.querySelector('button[type="submit"]').disabled = true;
  el.textContent = '启动中…';
  const fd = new FormData(form);
  const resp = await fetch(form.action, { method: 'POST', body: fd });
  const data = await resp.json();
  if(!data.ok){ el.textContent = JSON.stringify(data,null,2); form.querySelector('button[type="submit"]').disabled=false; return; }
  if(data.job_id){ poll(data.job_id); }
});
// Provider 切换提示
const selProv = form.querySelector('select[name="provider"]');
if(selProv){
  selProv.addEventListener('change', ()=>{
    const hp = document.getElementById('providerHint');
    if(hp) hp.textContent = '将使用: ' + selProv.value + '（模型以配置为准）';
  });
}
// 预填参数（来自 localStorage.runArgs）
try {
  const raw = localStorage.getItem('runArgs');
  if(raw){
    const args = JSON.parse(raw);
    if(args.srs_path) form.querySelector('input[name="srs_path"]').value = args.srs_path;
    if(args.data_path) form.querySelector('input[name="data_path"]').value = args.data_path;
    if(args.out) form.querySelector('input[name="out_path"]').value = args.out;
    if(args.planner) form.querySelector('select[name="planner"]').value = args.planner;
    if(args.executor) form.querySelector('select[name="executor"]').value = args.executor;
    if(args.critic) form.querySelector('select[name="critic"]').value = args.critic;
    if(args.reviser) form.querySelector('select[name="reviser"]').value = args.reviser;
    if(args.provider) form.querySelector('select[name="provider"]').value = args.provider;
    // 使用一次后清除
    localStorage.removeItem('runArgs');
  }
} catch(e) {}
</script>
