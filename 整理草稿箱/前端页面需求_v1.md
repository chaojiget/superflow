# 前端页面需求 v1（管理台原型）

> 目标：提供“运行/列表/得分”三页，覆盖最小闭环的提交、观测与回放；后续扩展到治理与配置。

## 1. 运行页（/run）
- 表单项：
  - SRS 文件路径/上传或文本框（必填）
  - 数据 CSV 路径（必填）
  - 输出路径（默认 reports/weekly_report.md）
  - 角色实现选择（planner/executor/critic/reviser，下拉）
  - LLM 参数（温度、重试、max_rows）
  - 预算/超时（可选）
- 行为：提交后触发后台 run，返回 trace_id 与结果摘要；链接到详情

## 2. 列表页（/episodes）
- 数据源：SQLite Outbox（config.outbox.sqlite_path）
- 列表字段：trace_id、状态、模型、提供商、得分、通过、延迟、创建时间
- 操作：查看事件（展开/详情页）、回放（review-only）、复跑（本地技能）

## 3. 得分页（/scores）
- 数据源：scores.sqlite（若无则提示先导出）
- 汇总：总数、平均分、通过率、平均延迟、P50/P95 延迟
- 分组：按模型/提供商汇总（count/avg_score/pass_rate）
- TopN：topN 明细表
- 导出：CSV（分组/明细）、HTML 下载

## 4. 技术与约束
- 技术：FastAPI + Jinja2（SSR），轻交互可用 htmx/Alpine.js
- 权限：本地内网使用，后续接入 OIDC
- 安全：不展示敏感信息（脱敏）；仅允许读取指定目录；复跑仅走本地技能

## 5. API 约定（v1）
- GET /api/episodes?limit=50
- GET /api/episodes/{trace_id}
- POST /api/run（body: srs_path, data_path, out, planner/executor/critic/reviser）
- GET /api/scores?group_by=model&since=...&until=...&topN=10

## 6. 后续扩展
- 配置编辑（config.json 可视化）
- 治理：审批流、预算阈值、敏感操作告警
- Router 可视：多提供商路由权重与失败率曲线

---

# 前端页面需求 v2（规划与新增能力）

> 目标：从“最小闭环控制台”升级为“带记忆、可编排、可部署”的 Agent 控制台；在对话中生成/编辑任务与工件，支持工作流与配置治理。

## A. Chat × 插件/工作流（Actions DSL）
- 统一动作协议（JSON）
  - 结构：
    - `{"action": {"type": "run|deploy|schedule|mcp_call|workflow", "args": {...}}, "srs": { ... }}`
  - 约定：
    - `run.args` 对应 `/api/run` 的字段（srs_path/data_path/out/planner/executor/critic/reviser/provider）
    - `deploy.args` 指定“页面/API/MCP 插件”的部署参数（见 C 节）
    - `schedule.args` 含 `after_seconds` 或 cron 片段；落库为 job
    - `workflow.args` 提供 workflow.json 的路径或内联定义
- 前端交互
  - 在 /chat 中识别动作，渲染“执行卡片”：
    - 立即运行：调用相应 API（如 `/api/run`）
    - 编辑并运行：把 args 预填入 `/run` 表单并切换到 Run Tab
    - 保存工作流：把动作序列保存为 workflow.json
- SRS 与工件
  - SRS 草稿保存至 `examples/srs/`，在执行卡片中显示“已保存路径”

## B. 工作流与定时（workflows/jobs）
- 存储（SQLite）
  - `workflows(id, name, definition_json, created_ts, enabled)`
  - `jobs(id, workflow_id, status(pending|running|done|failed), run_at, result_json, created_ts)`
- 后台调度
  - 5 秒扫描一次 `jobs`，对 `run_at <= now` 且 `pending` 的任务执行；执行完成写回 `result_json`
- 前端页面（/workflows）
  - 列表：名称、任务数、最近状态
  - 详情：定义查看、编辑（JSON/表单）、“运行一次”“延时运行（N秒）”
  - 任务列表：状态/时间/结果概览，支持重试
- API（v2 草案）
  - `POST /api/workflows`（创建/更新）
  - `GET /api/workflows`（列表）/ `GET /api/workflows/{id}`（详情）
  - `POST /api/jobs`（触发一次）/ `POST /api/jobs/schedule`（after_seconds）
  - `GET /api/jobs?workflow_id=...`（任务列表）

## C. 页面/API/MCP 插件化部署（Deployables）
- 页面（/pages）
  - 目标：将某些 run 的结果或报表以“静态页面片段”渲染与挂载（如 `/pages/sales_weekly`）
  - 操作：在执行卡片选择“部署为页面”，填写 `slug`、模板/样式可选项
  - 存储：`deployments(id, type, slug, spec_json, created_ts)`；页面内容以模板 + 数据渲染（Jinja）
- API（/api/ext/*）
  - 目标：将某 run/脚本以 HTTP API 形式暴露（GET/POST），仅本地/内网可用（有 Token）
  - 存储：在 `deployments` 记录路由/参数/鉴权策略
- MCP（工具注册）
  - 目标：注册外部 MCP 工具，映射到本系统 API；存储在 Registry 中
  - 安全：仅允许白名单域名，限流与审计

## D. 会话中心（/sessions）
- 列表：会话 id、创建时间、消息数、provider/model、token/cost 估算
- 详情：历史分页、删除/清空、导出为 md/txt
- 统计：近 7 天消息趋势、top 会话

## E. 配置页面（/config）
- 展示与编辑 `config.json` 关键项：
  - `llm.provider/model/temperature{role}/retries/max_rows`
  - `outbox.backend/sqlite_path`、`prompts.dir`、`scoreboard.episodes_dir`
- 行为：
  - 读取当前配置 → 表单渲染 → 保存（写回前校验 + 生成 `config.json.bak` 备份）
  - 保存后提示重启建议（或在不影响运行的前提下动态加载部分配置）

## F. 权限与安全（基础）
- 认证：Basic Auth 或 X-Admin-Token（从 `.env`/`config.json` 读取）
- IP 白名单：在 `config.security.ip_allowlist` 中声明
- 审计：
  - 记录管理台关键操作：保存配置/部署/运行/回放/复跑/删除会话/清空会话等
  - 日志可下载与检索

## G. 工作空间（Workspace）浏览与编辑（嵌入 /chat）
- 目标：在聊天页面左侧提供“工作空间”文件树，右侧提供“预览/编辑”双栏，类似 VSCode 轻量；支持选中文件片段插入到对话上下文
- 约束：
  - 根目录固定为仓库根（或可在 `/config` 指定 `workspace.root`）
  - 仅允许访问白名单后缀（`.md,.txt,.json,.py,.ts,.tsx,.js,.yaml,.yml,.toml` 等）；二进制禁止打开
  - 写入走受控 API，所有写操作写审计并显示 diff；大文件（>5MB）禁止读写
- 前端
  - 文件树：/api/ws/ls?path= 相对路径；点击展开/选中
  - 预览：/api/ws/read?path=（文本渲染；Markdown 支持预览）
  - 编辑：在“编辑”栏修改，保存调用 /api/ws/write（body: path, content, message）
  - 插入到对话：选中文本 → “插入到输入框”按钮 → 拼入 chat 输入
- API（v2 草案）
  - GET `/api/ws/ls?path=` 列目录（返回 name/is_dir/size/mtime）
  - GET `/api/ws/read?path=` 读文本文件（UTF-8）
  - POST `/api/ws/write` 写文件（校验后缀/大小；返回 sha/diff 摘要）
  - 所有 path 需做 `..` 规范化与根内校验
- 审计：写操作记录 `path/sha_before/sha_after/user/ts/message`

## H. 测试与契约
- Envelope 失败矩阵扩充：labels 非对象、authz.caps 混合类型、cost 非数值等
- /api/* Smoke Tests：`/api/run`、`/api/replay`、`/api/scores/report.html`、`/api/chat/send`、工作区读写 API
- pre-commit 集成：`pytest -q`、ruff/mypy

## I. 信息架构补充
- 顶部导航：Home / Run / Episodes / Scores / Chat / Workflows / Config
- Home：单页 Tab（Run/Episodes/Scores）保留；其余为独立路由
